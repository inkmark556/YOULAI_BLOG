<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOADING... | CODE PHANTOM</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Noto+Sans+SC:wght@400;700;900&display=swap');

        /* 视频容器样式 - 16:9 响应式，大屏占比优化 */
        .markdown-body .video-container {
            position: relative;
            padding-bottom: 56.25%;
            /* 16:9 比例 */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            width: 80vw;
            /* 横屏时占据 80% 视口宽度 */
            margin: 30px auto;
            /* 居中显示 */
            border: 3px solid black;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
        }

        .markdown-body .video-container iframe,
        .markdown-body .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* 移动端优化 - 小屏幕时占满宽度 */
        @media (max-width: 768px) {
            .markdown-body .video-container {
                width: 95vw;
                margin: 20px auto;
            }
        }

        /* Markdown 表格样式 - 虚线边框 */
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 2px dashed #333;
        }

        .markdown-body table thead {
            background: rgba(210, 5, 5, 0.1);
        }

        .markdown-body table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 900;
            border: 1px dashed #666;
            color: var(--p5-black);
        }

        .markdown-body table td {
            padding: 10px 15px;
            border: 1px dashed #999;
        }

        .markdown-body table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .markdown-body table tr:hover {
            background: rgba(252, 225, 0, 0.1);
        }
    </style>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css"
        rel="stylesheet" />

    <style>
        /* --- 基础变量 --- */
        :root {
            --p5-red: #D20505;
            --p5-black: #151515;
            --p5-grey: #222;
            --p5-white: #f0f0f0;
            --p5-paper: #fff;
            --p5-yellow: #fce100;
        }

        body {
            margin: 0;
            background-color: var(--p5-grey);
            font-family: 'Noto Sans SC', sans-serif;
            color: #333;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
        }

        /* --- Loading --- */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--p5-black);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }

        .loading-text {
            font-family: 'Bangers';
            color: var(--p5-white);
            font-size: 4rem;
            transform: rotate(-5deg);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            50% {
                transform: scale(1.1) rotate(-5deg);
                color: var(--p5-red);
            }
        }

        /* --- 导航 --- */
        .mini-nav {
            background: var(--p5-black);
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 30px;
            border-bottom: 4px solid var(--p5-red);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .home-btn {
            color: var(--p5-white);
            text-decoration: none;
            font-family: 'Bangers';
            font-size: 1.4rem;
            display: flex;
            align-items: center;
        }

        .home-btn:hover {
            color: var(--p5-yellow);
        }

        /* --- 布局 --- */
        .layout-container {
            max-width: 1400px;
            margin: 100px auto 40px;
            display: flex;
            gap: 40px;
            padding: 0 20px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* 侧边栏 */
        .toc-sidebar {
            width: 280px;
            flex-shrink: 0;
            position: sticky;
            top: 100px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--p5-white);
            padding: 20px;
            clip-path: polygon(0 0, 100% 0, 100% 95%, 90% 100%, 0 100%);
        }

        .toc-title {
            font-family: 'Bangers';
            color: var(--p5-red);
            font-size: 1.8rem;
            margin: 0 0 15px 0;
            border-bottom: 2px dashed #666;
        }

        #toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #toc-list a {
            display: block;
            color: #aaa;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: bold;
            padding: 5px 10px;
            border-left: 3px solid transparent;
            transition: 0.2s;
            transform: skewX(-5deg);
        }

        #toc-list a:hover,
        #toc-list a.active {
            color: black;
            background: var(--p5-yellow);
            border-left: 5px solid var(--p5-red);
        }

        #toc-list .toc-h3 {
            margin-left: 15px;
            font-size: 0.85rem;
        }

        /* 正文区 */
        .article-main {
            flex: 1;
            min-width: 0;
            background: var(--p5-paper);
            padding: 60px 80px;
            box-shadow: 10px 10px 0 var(--p5-black);
            border-top: 5px solid var(--p5-black);
        }

        /* --- Markdown 渲染样式 --- */
        .markdown-body h1 {
            font-size: 2.5rem;
            border-bottom: 4px solid var(--p5-black);
            padding-bottom: 10px;
            margin-top: 0;
        }


        /* --- P5R 风格行内代码 (Inline Code) --- */
        .markdown-body code:not([class*="language-"]) {
            background-color: rgba(210, 5, 5, 0.1);
            /* 淡淡的 P5 红背景 */
            color: #d20505;
            /* 鲜艳的红色文字 */
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 2px;
            /* 稍微圆角 */
            border-bottom: 2px solid rgba(210, 5, 5, 0.3);
            /* 底部加强，像记号笔划过 */
            font-weight: bold;
        }

        .markdown-body h2 {
            font-size: 1.8rem;
            margin-top: 50px;
            color: var(--p5-red);
            font-weight: 900;
        }

        .markdown-body h3 {
            font-size: 1.4rem;
            margin-top: 30px;
            border-left: 5px solid var(--p5-yellow);
            padding-left: 10px;
            background: #f9f9f9;
        }

        .markdown-body p {
            line-height: 1.8;
            margin-bottom: 20px;
            font-size: 1.05rem;
        }

        .markdown-body blockquote {
            background: #222;
            color: #ddd;
            border-left: 6px solid var(--p5-red);
            padding: 15px 20px;
            margin: 20px 0;
            font-style: italic;
        }

        /* 图片渲染优化 */
        .markdown-body img {
            max-width: 100%;
            border: 3px solid black;
            display: block;
            margin: 20px auto;
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.2);
        }

        /* 代码块样式 */
        .markdown-body pre {
            background: #1a1a1a !important;
            border: 1px solid #444;
            border-radius: 0;
            padding: 20px !important;
            margin: 20px 0;
        }

        /* --- P5 风格的代码复制按钮 (魔改 Prism Toolbar) --- */
        div.code-toolbar>.toolbar {
            opacity: 1 !important;
            /* 始终显示 */
            top: -10px;
            right: 10px;
        }

        div.code-toolbar>.toolbar>.toolbar-item>button {
            background: var(--p5-red) !important;
            color: white !important;
            border: 2px solid black !important;
            border-radius: 0 !important;
            font-family: 'Bangers', sans-serif !important;
            font-size: 0.9rem !important;
            padding: 5px 15px !important;
            box-shadow: 3px 3px 0 black !important;
            transform: rotate(2deg) !important;
            transition: 0.2s !important;
            text-transform: uppercase;
            cursor: pointer;
        }

        div.code-toolbar>.toolbar>.toolbar-item>button:hover {
            background: var(--p5-yellow) !important;
            color: black !important;
            transform: rotate(0deg) scale(1.1) !important;
        }

        /* 错误提示 */
        .error-msg {
            color: var(--p5-white);
            text-align: center;
            font-size: 2rem;
            font-family: 'Bangers';
            margin-top: 100px;
        }

        @media (max-width: 1024px) {
            .layout-container {
                flex-direction: column;
            }

            .toc-sidebar {
                width: auto;
                position: static;
                height: auto;
                margin-bottom: 20px;
            }

            .article-main {
                padding: 30px;
            }
        }

        /* 视频容器样式 - 16:9 响应式，大屏占比优化 */
        .markdown-body .video-container {
            position: relative;
            padding-bottom: 56.25%;
            /* 16:9 比例 */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            width: 80vw;
            /* 横屏时占据 80% 视口宽度 */
            margin: 30px auto;
            /* 居中显示 */
            border: 3px solid black;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
        }

        .markdown-body .video-container iframe,
        .markdown-body .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* 移动端优化 - 小屏幕时占满宽度 */
        @media (max-width: 768px) {
            .markdown-body .video-container {
                width: 95vw;
                margin: 20px auto;
            }
        }

        /* Markdown 表格样式 - 虚线边框 */
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 2px dashed #333;
        }

        .markdown-body table thead {
            background: rgba(210, 5, 5, 0.1);
        }

        .markdown-body table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 900;
            border: 1px dashed #666;
            color: var(--p5-black);
        }

        .markdown-body table td {
            padding: 10px 15px;
            border: 1px dashed #999;
        }

        .markdown-body table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .markdown-body table tr:hover {
            background: rgba(252, 225, 0, 0.1);
        }
    </style>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']], // 让 $E=mc^2$ 生效
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>

<body>

    <div id="loading-screen">
        <div class="loading-text">TAKE YOUR TIME...</div>
    </div>

    <nav class="mini-nav">
        <a href="../index.html" class="home-btn"><span>◄ PHANTOM THIEVES</span></a>
    </nav>

    <div id="error-container" style="display:none;"></div>

    <div class="layout-container" id="main-content">
        <aside class="toc-sidebar">
            <h3 class="toc-title">NAVIGATE</h3>
            <ul id="toc-list"></ul>
        </aside>

        <main class="article-main">
            <div id="content-render-area" class="markdown-body"></div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const postId = params.get('id');

            const loadingScreen = document.getElementById('loading-screen');
            const contentArea = document.getElementById('main-content');
            const renderArea = document.getElementById('content-render-area');
            const tocList = document.getElementById('toc-list');
            const errorContainer = document.getElementById('error-container');

            if (!postId) {
                showError("NO ID FOUND - TARGET LOST");
                return;
            }

            // 动态请求 MD 文件
            fetch(`/posts/${postId}.md`)
                .then(response => {
                    if (!response.ok) throw new Error("FILE NOT FOUND (404)");
                    return response.text();
                })
                .then(text => {
                    // 1. 解析 MD -> HTML
                    renderArea.innerHTML = marked.parse(text);

                    // 设置标题
                    const h1 = renderArea.querySelector('h1');
                    if (h1) document.title = h1.innerText + " | CODE PHANTOM";

                    // 2. 【新】修正图片路径
                    // MD里写 ![xx](img/1.png) -> 浏览器解析为 root/img/1.png (错)
                    // 修正为 root/posts/img/1.png (对)
                    const imgs = renderArea.querySelectorAll('img');
                    imgs.forEach(img => {
                        const src = img.getAttribute('src');
                        // 如果不是网络图片(http)且不是绝对路径(/)
                        if (!src.startsWith('http') && !src.startsWith('//') && !src.startsWith('/')) {
                            img.src = '/posts/' + src; // 使用绝对路径 /posts/
                        }
                    });

                    // 3. 代码高亮 & 复制按钮
                    Prism.highlightAll();

                    // 4. 【新】渲染数学公式 (MathJax)
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        window.MathJax.typesetPromise([renderArea]).catch((err) => {
                            console.warn('MathJax rendering failed:', err);
                        });
                    }

                    // 5. 生成目录
                    generateTOC();

                    // 6. 显示内容
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => loadingScreen.remove(), 500);
                    contentArea.style.opacity = '1';
                })
                .catch(err => {
                    showError(err.message);
                });

            // --- 辅助工具 ---
            function showError(msg) {
                loadingScreen.style.display = 'none';
                errorContainer.style.display = 'block';
                errorContainer.innerHTML = `<div class="error-msg">⚠️ ${msg}</div>`;
            }

            function generateTOC() {
                const headers = renderArea.querySelectorAll('h1, h2, h3');
                headers.forEach((header, index) => {
                    const id = 'header-' + index;
                    header.id = id;

                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = '#' + id;
                    a.innerText = header.innerText;
                    if (header.tagName === 'H3') a.classList.add('toc-h3');

                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
                    });

                    li.appendChild(a);
                    tocList.appendChild(li);
                });

                // 滚动监听
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            document.querySelectorAll('#toc-list a').forEach(link => link.classList.remove('active'));
                            const activeLink = document.querySelector(`#toc-list a[href="#${entry.target.id}"]`);
                            if (activeLink) activeLink.classList.add('active');
                        }
                    });
                }, { rootMargin: '-100px 0px -70% 0px' });
                headers.forEach(h => observer.observe(h));
            }
        });
    </script>
</body>

</html>
